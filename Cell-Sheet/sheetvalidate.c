#include "sheet.h"
#include <ctype.h>
#include <string.h>
int isvalidnumber(const char* s) {
//چک کردن اینکه فرمول از نظر منطقی و گرامری درست باشه مثلا پرانتز ها درست باز و بسته شدن یا عملگرها به درستی استفاده شدن
    //هدف این تابع بررسی اینکه یک رشته عدد معتبر هست یا نه
    if (!s || !*s) {
        return 0;
        //بررسی اینکه رشته خالی یا NULL نباشد
    }
    const char* p = s;
    if (*p == '+' || *p == '-') p++; //اگر رشته با مثبت یا منفی شروع شده باشد نادیده میگیره
    int hasDigit = 0; //گشتن دنبال رقم 
    while (*p && isdigit((unsigned char)*p)) { 
        hasDigit = 1; 
        p++; 
    }
    if (*p == '.') {
        //اگر رشته شامل ممیز باشه مجددا دنبال رقم میگرده تا مطمین بشه که بعد از ممیز هم رقم وجود داره
        p++;
        while (*p && isdigit((unsigned char)*p)) { hasDigit = 1; p++; }
    }
    return hasDigit && (*p == '\0');
    // در آخر اگر یک رقم پیدا شده باشه و رشته با کاراکتر \0 تمام شود تابع مقدار 1 یعنی درست یا 0 غلط رو میده
}

int sanitize_Formula(const char* formula) {
    //هدف کار این تابع فرمول رو پاکسازی میکنه یعنی مطمین بشیم که فقط کاراکتر های مجاز در اون وجود دارن  و پرانتز ها به درستی بسته شده اند
    if (!formula){
         return 0;
         //بررسی معتبر بودن یا نبودن فرمول
    }
    size_t tol = strlen(formula); //محاسبه طول فرمول
    if (tol == 0 || tol >= Max_formula_tol) return 0;

    int balance = 0; //متغیری برای شمارش پرانتزها
    for (size_t i = 0; i < tol; i++) {
        //برای هر کاراکتر از فرمول حلفه درست کردیم تا بررسی کنیم
        unsigned char c = (unsigned char)formula[i];
        int allowed =
            isalpha(c) || isdigit(c) ||
            c == '+' || c == '-' || c == '*' || c == '/' || c == '^' ||
            c == '(' || c == ')' || c == '.' || c == '_' ||
            c == ',' || c == ' ';
//انواع کاراکتر های مجاز رو بالا نمایش دادیم
        if (!allowed) return 0; //بررسی اینکه کاراکتر مجاز هست یا نه
        if (c == '(') balance++; //در صورت باز بودن پرانتز
        else if (c == ')') {
            balance--; // در صورت بسته بودن پرانتز
            if (balance < 0){
                 return 0;
                 //اگر شمارش پرانتز ها منفی بشه یعنی پرانتز ها به درستی بسته نشده اند
            } 
        }
    }
    return balance == 0;
    //در آخر اگر شمارش پرانتز ها صفر شد یعنی تعداد پرانتز های باز و بسته برابر بوده و فرمول معتبر هست
}

/*
توضیج راجب size_t
یک نوع داده برای برای نشون دادن اندازه و طول استفاده میشه
*/